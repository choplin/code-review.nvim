# üìù code-review.nvim

A lightweight Neovim plugin for adding inline code review comments and exporting them in various formats. Perfect for reviewing code generated by AI assistants, conducting code reviews, or taking notes while reading code.

## ‚ú® Features

- üéØ **Instant comments** - No session management needed, just start commenting
- üìç **Smart positioning** - Comment popup appears near your cursor
- üëÅÔ∏è **View comments** - Show comments at cursor position with `<leader>rs`
- ‚úèÔ∏è **Live editing** - Edit reviews in preview buffer, save with `:w`
- üìÑ **Multiple formats** - Export as Markdown or JSON
- üîç **Visual mode** - Comment on selected code blocks
- üé® **Clean UI** - Minimal floating windows, close with `q`

## üì¶ Installation

### Using [lazy.nvim](https://github.com/folke/lazy.nvim)

```lua
{
  'choplin/code-review.nvim',
  config = function()
    require('code-review').setup()
  end,
}
```

### Using [packer.nvim](https://github.com/wbthomason/packer.nvim)

```lua
use {
  'choplin/code-review.nvim',
  config = function()
    require('code-review').setup()
  end,
}
```

## üöÄ Quick Start

1. Add comments (session starts automatically):
   - At cursor: `:CodeReviewComment` or `<leader>rc`
   - With context: `:CodeReviewComment 3` or `3<leader>rc` (includes 3 lines before/after)
   - Visual selection: Select lines and press `<leader>rc`
   - Submit comment: `<C-CR>` (both insert and normal mode)
2. View comments at cursor: `:CodeReviewShowComment` or `<leader>rs`
3. Preview your review: `:CodeReviewPreview` or `<leader>rp`
4. Save or copy:
   - Save to file: `:CodeReviewSave [path]` or `<leader>rw`
   - Copy to clipboard: `:CodeReviewCopy` or `<leader>ry`
5. Clear all comments: `:CodeReviewClear` or `<leader>rx`

## üõ†Ô∏è Configuration

<details>
<summary>Click to see default configuration</summary>

```lua
require('code-review').setup({
  -- UI settings
  ui = {
    -- Comment input window
    input_window = {
      width = 60,
      height = 2,
      max_height = 20,  -- Auto-expand up to this height
      border = 'rounded',
      title = ' Add Comment (C-CR to submit) ',
      title_pos = 'center',
    },
    -- Preview window
    preview = {
      format = 'markdown', -- 'markdown', 'json', or 'auto' (same as output.format)
      split = 'vertical', -- 'vertical', 'horizontal', or 'float'
      vertical_width = 80,
      horizontal_height = 20,
      float = {
        width = 0.8,
        height = 0.8,
        border = 'rounded',
        title = ' Review Preview ',
        title_pos = 'center',
      },
    },
  },
  -- Output settings
  output = {
    format = 'markdown', -- 'markdown' or 'json'
    date_format = '%Y-%m-%d %H:%M:%S',
    save_dir = nil, -- nil = current directory
  },
  -- Keymaps (set to false to disable all keymaps)
  keymaps = {
    clear = '<leader>rx',
    add_comment = '<leader>rc',
    preview = '<leader>rp',
    save = '<leader>rw',
    copy = '<leader>ry',
    show_comment = '<leader>rs',
  },
})
```

</details>

## üîß Advanced Configuration

<details>
<summary>Custom Keymaps and Autocmds</summary>

### Manual Keymap Setup

If you prefer to set up keymaps manually instead of using the `keymaps` config:

```lua
require('code-review').setup({
  keymaps = false,  -- Disable automatic keymaps
})

-- Set up your own keymaps
local cr = require('code-review')
vim.keymap.set({'n', 'v'}, '<leader>rc', cr.add_comment, { desc = "Add review comment" })
vim.keymap.set('n', '<leader>rp', cr.preview, { desc = "Preview review" })
vim.keymap.set('n', '<leader>rw', cr.save, { desc = "Save review to file" })
vim.keymap.set('n', '<leader>ry', cr.copy, { desc = "Copy review to clipboard" })
vim.keymap.set('n', '<leader>rs', cr.show_comment_at_cursor, { desc = "Show comment at cursor" })
vim.keymap.set('n', '<leader>rx', cr.clear, { desc = "Clear all comments" })
```

### Buffer-Specific Keymaps

You can set up keymaps for specific code-review buffers using autocmds:

```lua
-- Comment input buffer keymaps
vim.api.nvim_create_autocmd('User', {
  pattern = 'CodeReviewInputEnter',
  callback = function(ev)
    local buf = ev.data.buf
    local cr = require('code-review')
    local funcs = cr.get_input_buffer_functions(buf)
    
    -- Submit with C-CR in both insert and normal mode
    vim.keymap.set({'i', 'n'}, '<C-CR>', funcs.submit, { buffer = buf })
    -- Cancel with Esc or q in normal mode
    vim.keymap.set('n', '<Esc>', funcs.cancel, { buffer = buf })
    vim.keymap.set('n', 'q', funcs.cancel, { buffer = buf })
  end
})

-- Preview buffer keymaps
vim.api.nvim_create_autocmd('User', {
  pattern = 'CodeReviewPreviewEnter',
  callback = function(ev)
    local buf = ev.data.buf
    -- Custom keymaps for preview buffer
    vim.keymap.set('n', 'q', '<cmd>close<CR>', { buffer = buf })
    vim.keymap.set('n', '<C-s>', function()
      vim.cmd('write')  -- Save edits
      require('code-review').save()  -- Save to file
    end, { buffer = buf })
  end
})

-- Comment view buffer keymaps
vim.api.nvim_create_autocmd('User', {
  pattern = 'CodeReviewCommentsEnter',
  callback = function(ev)
    local buf = ev.data.buf
    vim.keymap.set('n', 'q', '<cmd>close<CR>', { buffer = buf })
    vim.keymap.set('n', '<Esc>', '<cmd>close<CR>', { buffer = buf })
  end
})
```

### Available User Events

- `CodeReviewInputEnter` - Fired when comment input window opens
  - `ev.data.buf` - Buffer number
  - `ev.data.win` - Window number
- `CodeReviewPreviewEnter` - Fired when preview window opens
  - `ev.data.buf` - Buffer number
- `CodeReviewCommentsEnter` - Fired when comment list window opens
  - `ev.data.buf` - Buffer number

### Helper Functions

```lua
-- Check if a buffer is a code-review buffer
local function is_code_review_buffer(bufnr)
  bufnr = bufnr or 0
  local name = vim.api.nvim_buf_get_name(bufnr)
  return name:match("^codereview://") ~= nil
end
```

</details>

## üìù Usage Examples

### Basic Review Workflow

```vim
" Add comment to current line (session starts automatically)
:CodeReviewComment

" Add comment with 5 lines of context
:CodeReviewComment 5

" Show comments at cursor position
:CodeReviewShowComment

" Preview and edit
:CodeReviewPreview
" Make edits in the preview buffer
:w  " Save changes back to review

" Export
:CodeReviewSave ~/reviews/myreview.md
:CodeReviewCopy

" Clear all comments
:CodeReviewClear
```

### Visual Mode Selection

1. Enter visual mode: `v` or `V`
2. Select the code range
3. Press `<leader>rc` to add a comment to the selection

### Editing Reviews

The preview buffer is fully editable. You can:

- Modify comment text directly
- Delete entire comment sections
- Reorder comments
- Save with `:w` to update the review
- Close with `q`

### Viewing Comments

When working on a file with existing comments:

```vim
" Show comments at current cursor position
:CodeReviewShowComment
" or press <leader>rs
```

The comment viewer will:
- Display all comments that include the current line
- Show in a floating window near the cursor
- Close with `q` or `<Esc>`

## üìÑ Output Formats

### Markdown Format

```markdown
# Code Review

**Date**: 2024-01-30 14:30:00
**Total Comments**: 3

## src/main.lua

### Line 42
**Time**: 2024-01-30 14:30:00

```

42: local function process_data(input)

```
This function needs error handling for nil input.

### Lines 100-105
**Time**: 2024-01-30 14:30:15

```

100: for i, item in ipairs(items) do
101: if item.valid then
102: table.insert(results, item)
103: end
104: end

```
Consider using table.filter for better readability.
```

### JSON Format

```json
{
  "date": "2024-01-30 14:30:00",
  "comment_count": 2,
  "comments": [
    {
      "id": "1706621400_1234",
      "file": "src/main.lua",
      "line_start": 42,
      "line_end": 42,
      "comment": "This function needs error handling for nil input.",
      "timestamp": 1706621400,
      "context_lines": ["local function process_data(input)"]
    }
  ]
}
```

## üîß Commands

| Command                      | Description                                                 |
| ---------------------------- | ----------------------------------------------------------- |
| `:CodeReviewComment [lines]` | Add comment at cursor/selection with optional context lines |
| `:CodeReviewShowComment`     | Show comments at cursor position                            |
| `:CodeReviewPreview`         | Open preview window with editable content                   |
| `:CodeReviewSave [path]`     | Save review to file                                         |
| `:CodeReviewCopy`            | Copy review to clipboard                                    |
| `:CodeReviewClear`           | Clear all review comments                                   |

## üî® Development

### Setup

```bash
# Install formatter and linter
cargo install stylua
luarocks install luacheck
```

### Commands

```bash
# Format code
make format

# Run linter
make lint

# Run both
make check
```

## ü§ù Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## üìú License

MIT License - see LICENSE file for details

